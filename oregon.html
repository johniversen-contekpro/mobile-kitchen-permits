<!-- 
  WEBFLOW EMBED TEMPLATE (UPDATED)
  Copy this code into your Webflow Embed element on the Collection Template page
  
  IMPORTANT: In Webflow, use the field slugs directly (e.g., tool-url, tool-slug)
  Webflow will automatically replace them with the actual values.
  
  CMS Fields Required:
  - tool-url (Plain Text field) - The hosted HTML file URL
  - tool-slug (Plain Text field) - URL-friendly identifier (optional for resize, but useful for multiple tools)
-->

<div class="tool-wrapper" style="width: 100%; min-height: 600px; position: relative; overflow: visible;">
  <iframe 
    id="tool-iframe-{{wf {&quot;path&quot;:&quot;slug&quot;,&quot;type&quot;:&quot;PlainText&quot;\} }}"
    src="{{wf {&quot;path&quot;:&quot;github-url&quot;,&quot;type&quot;:&quot;PlainText&quot;\} }}" 
    width="100%" 
    frameborder="0"
    style="border: none; width: 100%; min-height: 600px; display: block;"
    scrolling="no">
  </iframe>
</div>

<script>
(function() {
  'use strict';
  
  // Get the iframe element
  const iframe = document.getElementById('tool-iframe-{{wf {&quot;path&quot;:&quot;slug&quot;,&quot;type&quot;:&quot;PlainText&quot;\} }}');
  if (!iframe) return;
  
  const toolSlug = '[tool-slug]';
  
  // Function to resize the iframe
  function resizeIframe(height) {
    if (height && height > 0) {
      iframe.style.height = height + 'px';
      iframe.style.minHeight = height + 'px';
      iframe.style.maxHeight = 'none';
      console.log('Tool iframe resized to:', height, 'px');
    }
  }
  
  // Set initial height
  resizeIframe(600);
  
  // Listen for resize messages from iframe (handles multiple message formats)
  window.addEventListener('message', function(event) {
    // Optional: Verify origin for security
    // Replace with your GitHub Pages domain if needed
    // if (event.origin !== 'https://yourusername.github.io') return;
    
    // Handle different message formats that the tool might send
    let height = null;
    
    // Format 1: Just a number (height value)
    if (typeof event.data === 'number' && event.data > 0) {
      height = event.data;
    }
    // Format 2: Object with type 'resize'
    else if (event.data && typeof event.data === 'object') {
      if (event.data.type === 'resize' && event.data.height) {
        height = event.data.height;
      }
      // Format 3: Object with just 'height' property
      else if (event.data.height) {
        height = event.data.height;
      }
      // Format 4: Legacy format with 'tool-resize' type and slug
      else if (event.data.type === 'tool-resize' && event.data.height) {
        // Check slug if provided, otherwise accept any
        if (!event.data.slug || event.data.slug === toolSlug) {
          height = event.data.height;
        }
      }
    }
    
    // Apply the height if we got a valid value
    if (height) {
      resizeIframe(height);
    }
  });
  
  // Try to resize on iframe load (works for same-origin only)
  iframe.addEventListener('load', function() {
    // Request initial resize after a delay
    setTimeout(function() {
      try {
        // Try direct access (same-origin)
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        if (iframeDoc && iframeDoc.body) {
          const height = Math.max(
            iframeDoc.body.scrollHeight,
            iframeDoc.documentElement.scrollHeight
          ) + 50; // Add buffer
          resizeIframe(height);
        }
      } catch (e) {
        // Cross-origin restriction - will use postMessage instead
        console.log('Cross-origin iframe - using postMessage for resize');
        
        // Request resize from iframe
        try {
          iframe.contentWindow.postMessage({ type: 'requestResize' }, '*');
        } catch (err) {
          console.log('Could not send resize request to iframe');
        }
      }
    }, 500);
    
    // Also try again after longer delay for dynamic content
    setTimeout(function() {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        if (iframeDoc && iframeDoc.body) {
          const height = Math.max(
            iframeDoc.body.scrollHeight,
            iframeDoc.documentElement.scrollHeight
          ) + 100;
          resizeIframe(height);
        }
      } catch (e) {
        // Cross-origin - rely on postMessage
      }
    }, 2000);
  });
  
  // Also listen for window resize events and request iframe to resize
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      try {
        iframe.contentWindow.postMessage({ type: 'requestResize' }, '*');
      } catch (e) {
        // Cross-origin restriction
      }
    }, 300);
  });
})();
</script>

<style>
  .tool-wrapper {
    position: relative;
    overflow: visible !important; /* Important: prevents cropping */
    width: 100%;
    min-height: 600px;
  }
  
  .tool-wrapper iframe {
    display: block;
    border: none;
    width: 100%;
  }
  
  /* Ensure parent containers don't clip content */
  .tool-wrapper * {
    overflow: visible !important;
  }
</style>

